name: Sync Common Folder
on:
  repository_dispatch:
    types: [common_lib_updated]

jobs:
  sync:
    # --- 1. ループ防止（自己PR防止）の判定 ---
    # 共通リポジトリ（ZazLib）から送られた「対象リポジトリ名」と「自分の名前」を比較
    # 両者を小文字にして比較し、一致しない（＝他プロジェクトからの更新）場合のみ実行する
    if: |
      github.event.client_payload.target_repo != null &&
      toLowerCase(github.event.client_payload.target_repo) != toLowerCase(github.repository)

    runs-on: ubuntu-latest
    steps:
      # --- 2. デバッグ用：文字列の比較ログ（Actionsのログで確認可能） ---
      - name: Debug Context Check
        run: |
          echo "--- Context Check ---"
          echo "Payload (from ZazLib): '${{ github.event.client_payload.target_repo }}'"
          echo "Current (This Repo):  '${{ github.repository }}'"
          echo "---------------------"

      # --- 3. リポジトリの取得 ---
      - name: Checkout Project Repo
        uses: actions/checkout@v4
        with:
          path: project-repo

      - name: Checkout Common Lib Repo
        uses: actions/checkout@v4
        with:
          repository: zaz4416/ZazLib # ★共通リポジトリ名
          token: ${{ secrets.MY_PAT }}
          path: common-lib

      # --- 4. フォルダ同期（rsync） ---
      - name: Sync zazlib Folder
        run: |
          mkdir -p project-repo/zazlib/
          # 共通側のルートをプロジェクトのzazlibフォルダへ同期（Git関連は除外）
          rsync -av --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            common-lib/ project-repo/zazlib/

      # --- 5. 変更があればプルリクエスト作成 ---
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          path: project-repo
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🤖 共通ライブラリを最新に同期"
          branch: sync-common-library
          title: "🤖 共通ライブラリの自動同期"
          body: |
            共通リポジトリ(ZazLib)からの更新通知を受信しました。
            `zazlib` フォルダの内容を最新状態に同期しました。
            
            ※このPRは自動生成されました。
